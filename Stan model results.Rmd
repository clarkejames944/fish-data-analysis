---
title: "Stan model results"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

I have created a total of 10 Stan models with differing levels of complexity. These models are as follows:

1. Simple no threshold model. -no threshold and a fixed intercept.
2. Simple no threshold varying intercept model. -no threshold but with varying intercepts via fish individual
3. Unhinged fixed threshold and intercept. -The discontinuous piecewise linear regression
4. Unhinged fixed threshold, varying intercept.
5. Unhinged fixed intercept varying threshold.
6. Unhinged varying threshold and intercept.
7. Hinged fixed threshold and intercept. -The continuous piecewise linear regression
8. Hinged varying intercept fixed threshold.
9. Hinged varying threshold fixed intercept.
10. Hinged varying threshold and intercept.


##1. Simple no threshold model##
Notation:
$y_{i} = \alpha + \beta x_{i} + \epsilon$ 

(Good)
Max treedepth= 10
Adapt Delta= 0.8
- run time= ~30s
- Max. Treedepth exceeded=0
- low BFMI=0
- Divergences=0

#Pairs plot#
```{r}
pairs(fit, pars=c("alpha","beta","epsilon","lp__", "yhat[110]"))
```

#Extracted#
```{r}
fishdat1 %>% 
  ggplot() +
  geom_point(aes(x = (prev)^2, y = (oto_size)^2, colour=maturity), alpha=0.1) +
  geom_point(aes(x = (prev)^2, y = mean_oto_size), colour="gold2", alpha=0.25, size=0.25) +
  geom_ribbon(aes(x=(prev)^2, ymin = lower, ymax = upper), alpha = 0.25)+
  theme_classic()
```

##2. Simple no threshold varying intercept model##
Notation:
$y_{i} = \alpha_{j \left[{i}\right]} + \beta x_{i} + \epsilon$

Max treedepth=10
Adapt Delta=0.8
- run time= ~3min
- Max. Treedepth exceeded= 499
- low BFMI=0
- Divergences=0

Worked well with a Max treedepth of 12:
(Good)
Max treedepth=12
Adapt Delta=0.8
- run time= ~40s
- Max. Treedepth exceeded= 0
- low BFMI=0
- Divergences=0
```{r}
pairs(two_fit, pars=c("alpha[110]","beta","epsilon","lp__", "sigma_alpha", "yhat[110]"))
```

#Extracted#



##3. Unhinged fixed threshold + intercept##
Notation:
$y_{i} = \{^{\alpha_{1} +  \beta_{1} x_{i} + \epsilon\;\;  if\;x_{i} \le \eta} _{\alpha_{2} +  \beta_{2} x_{i} + \epsilon\;\;  if\;not}$

constraint on bp. upper limit is 4
Max treedepth= 10
Adapt Delta= 0.8
- run time= ~42min
- Max. Treedepth exceeded= 3935 
- low BFMI=1
- Divergences= 0

with bp normal but no upper constraint
Max treedepth= 10
Adapt Delta= 0.8
- run time= ~49min
- Max. Treedepth exceeded= 3986
- low BFMI=0
- Divergences= 0

with bp as uniform
Max treedepth= 10
Adapt Delta= 0.8
- run time= ~18min
- Max. Treedepth exceeded= 1000 
- low BFMI=1
- Divergences= 2403

using the complicated 3 model
Max treedepth= 10
Adapt Delta= 0.8
- run time= ~46min
- Max. Treedepth exceeded= 3253 
- low BFMI=1
- Divergences= 0

using the 'Another possible unhinged' model
Max treedepth= 10
Adapt Delta= 0.8
- run time= ~7min
- Max. Treedepth exceeded= 3986
- low BFMI=0
- Divergences= 0

using the 'Another possible unhinged' model
Max treedepth= 15
Adapt Delta= 0.8
- run time= ~264min
- Max. Treedepth exceeded= 3797
- low BFMI=0
- Divergences= 0


#Pairs plot#
```{r}
pairs(three_fit, pars=c("intercept1", "intercept2", "bp", "mu_bp", "sigma_bp","beta[1]", "beta[2]", "error","lp__", "sigma_int1", "sigma_int2", "yhat[110]"))
```

#Extracted#



####4. Unhinged fixed threshold, varying intercept###
Notation:
$y_{i} = \{^{\alpha_{1 _{{j} \left[{i}\right]}} +  \beta_{1} x_{i} + \epsilon\;\;\;  if \;x_{i} \le \eta} _{\alpha_{2_{{j} \left[{i}\right]}} +  \beta_{2} x_{i} + \epsilon\;\;\;  if \;not}$

Max treedepth= 10
Adapt Delta= 0.8
- run time= ~60min
- Max. Treedepth exceeded=3905 
- low BFMI=2
- Divergences= 95

Upper bound of 4 for the bp.
Max treedepth= 10
Adapt Delta= 0.8
- run time= ~92min
- Max. Treedepth exceeded= 3961 
- low BFMI=3
- Divergences= 39



Max treedepth= 10
Adapt Delta= 0.85
- run time= ~10min
- Max. Treedepth exceeded= 0 
- low BFMI=4
- Divergences= 1813

Max treedepth= 10
Adapt Delta= 0.875
- run time= ~27min
- Max. Treedepth exceeded= 966
- low BFMI=4
- Divergences= 1688

#Pairs plot#
```{r}
pairs(four_fit, pars=c("alpha1[110]", "alpha2[110]", "eta","beta[1]", "beta[2]", "epsilon","lp__", "sigma_alpha1", "sigma_alpha2", "yhat[110]"))
```

#Extracted#


####5. Unhinged fixed intercept varying threshold###
Notation:
$y_{i} = \{^{\alpha_{1} +  \beta_{1} x_{i} + \epsilon\;\;\;  if \;x_{i} \le \eta_{j \left[{i}\right]}} _{\alpha_{2} +  \beta_{2} x_{i} + \epsilon\;\;\;  if \;not}$

Max treedepth= 10
Adapt Delta= 0.8
- run time= ~77min
- Max. Treedepth exceeded= 4000 
- low BFMI=0
- Divergences= 0

Max treedepth= 15
Adapt Delta= 0.8
- run time= ~62min
- Max. Treedepth exceeded= 4000 
- low BFMI=0
- Divergences= 0


#Pairs plot#
```{r}
pairs(five_fit, pars=c("alpha1", "alpha2", "eta[110]", "mu_eta", "sigma_eta","beta[1]", "beta[2]", "epsilon","lp__", "yhat[110]"))
```

#Extracted#


####6. Unhinged varying threshold and intercept###
Notation:

$y_{i} = \{^{\alpha_{1 _{{j} \left[{i}\right]}} +  \beta_{1} x_{i} + \epsilon\;\;\;  if\; x_{i} \le \eta_{j \left[{i}\right]}} _{\alpha_{2_{{j} \left[{i}\right]}} +  \beta_{2} x_{i} + \epsilon\;\;\;  if \;not}$

Max treedepth= 10
Adapt Delta= 0.8
- run time= ~64min
- Max. Treedepth exceeded= 4000 
- low BFMI=0
- Divergences= 0

#Pairs plot#
```{r}
pairs(six_fit, pars=c("alpha1[110]", "alpha2[110]", "eta[110]", "mu_eta", "sigma_eta","beta[1]", "beta[2]", "epsilon","lp__", "sigma_alpha1", "sigma_alpha2", "yhat[110]"))
```

#Extracted#



####7. Hinged fixed threshold and intercept###
Notation:
$y_{i} = \alpha + \beta_{1} x_{i} + \beta_{2} \left(x_{i} - \eta\right) \tau_{i} + \epsilon$



$\tau_{i} = \{^{0\;\;\;if \;x_{i} \le \eta} _{1 \;\;\;if \;not}$

Max treedepth= 10
Adapt Delta= 0.8
- run time= ~5min
- Max. Treedepth exceeded= 0 
- low BFMI=0
- Divergences= 272

Constrain bp's upper limit to 4
(Good model)-but wrong eta value
Max treedepth= 10
Adapt Delta= 0.8
- run time= ~8min
- Max. Treedepth exceeded= 0 
- low BFMI=0
- Divergences= 0

After cutting the data to above the wrong breakpoint being discovered
Max treedepth= 10
Adapt Delta= 0.8
- run time= ~7min
- Max. Treedepth exceeded= 583
- low BFMI=0
- Divergences= 519

Max treedepth= 10
Adapt Delta= 0.85
- run time= ~6min
- Max. Treedepth exceeded= 0
- low BFMI=0
- Divergences= 684

Max treedepth= 10
Adapt Delta= 0.9
- run time= ~4min
- Max. Treedepth exceeded= 9
- low BFMI=0
- Divergences= 62

Specified that the minimum value of the breakpoint was 0.15
Max treedepth= 10
Adapt Delta= 0.9
- run time= ~4min
- Max. Treedepth exceeded= 5
- low BFMI=0
- Divergences= 88

#Pairs plot#
```{r}
pairs(seven_fit, pars=c("alpha", "eta","beta1", "beta2", "epsilon","lp__", "yhat[110]", "slope_after", "intercept_after"))
```

#Extracted#



####8. Hinged varying intercept fixed threshold###
Notation:
$y_{i} = \alpha_{j \left[{i}\right]} + \beta_{1} x_{i} + \beta_{2} \left(x_{i} - \eta\right) \tau_{i} + \epsilon$



$\tau_{i} = \{^{0\;\;\;  if \;x_{i} \le \eta} _{1\;\;\; if \;not}$

Max treedepth= 10
Adapt Delta= 0.8
- run time= ~9min
- Max. Treedepth exceeded= 0 
- low BFMI=0
- Divergences= 1005

Contrain bp upper limit to 4
(Good model)
Max treedepth= 10
Adapt Delta= 0.8
- run time= ~17min
- Max. Treedepth exceeded= 0 
- low BFMI=0
- Divergences= 0


#Pairs plot#
```{r}
pairs(eight_fit, pars=c("alpha[110]", "eta","beta1", "beta2", "epsilon","lp__", "sigma_alpha", "yhat[110]", "slope_after", "intercept_after[110]"))
```

#Extracted#



####9. Hinged varying threshold fixed intercept###
Notation:
$y_{i} = \alpha + \beta_{1} x_{i} + \beta_{2} \left(x_{i} - \eta_{j \left[{i}\right]}\right) \tau_{i} + \epsilon$



$\tau_{i} = \{^{0\;\;\;  if \;x_{i} \le \eta_{j \left[{i}\right]}} _{1 \;\;\;if \;not}$

Max treedepth= 10
Adapt Delta= 0.8
- run time= ~14min
- Max. Treedepth exceeded= 0 
- low BFMI=1
- Divergences= 0

Constrain upper limit of bp at 4
Max treedepth= 10
Adapt Delta= 0.8
- run time= ~16min
- Max. Treedepth exceeded= 0 
- low BFMI=1
- Divergences= 0

Constrain upper limit of mu_bp at 4
Max treedepth= 10
Adapt Delta= 0.8
- run time= ~14min
- Max. Treedepth exceeded= 0 
- low BFMI=2
- Divergences= 0

#Pairs plot#
```{r}
pairs(nine_fit, pars=c("alpha", "eta[110]", "mu_eta", "sigma_eta","beta1", "beta2", "epsilon","lp__", "yhat[110]","slope_after", "intercept_after[110]"))
```

#Extracted#




####10. Hinged varying threshold and intercept###
Notation:
$y_{i} = \alpha_{j\left[{i}\right]} + \beta_{1} x_{i} + \beta_{2} \left(x_{i} - \eta_{j \left[{i}\right]}\right) \tau_{i} + \epsilon$



$\tau_{i} = \{^{0\;\;\;  if \;x_{i} \le \eta_{j \left[{i}\right]}} _{1 \;\;\;if\; not}$

Max treedepth= 10
Adapt Delta= 0.8
- run time= ~23min
- Max. Treedepth exceeded= 292
- low BFMI=4
- Divergences= 0

(Good)
Max treedepth= 12
Adapt Delta= 0.8
- run time= ~23min
- Max. Treedepth exceeded= 0
- low BFMI=4
- Divergences= 0

#Pairs plot#
```{r}
pairs(ten_fit, pars=c("alpha[110]", "eta[110]", "mu_eta", "sigma_eta","beta1", "beta2", "epsilon","lp__", "sigma_alpha", "yhat[110]", "slope_after", "intercept_after[110]"))
```

#Extracted#

```{r}
for (i in seq_along(ten_post$lp__)) {
  segments(x0 = min(fishdat$prev), x1 = ten_post$bp[i], 
           y0 = ten_post$intercept[i] + ten_post$beta1* min(fishdat$prev), 
           y1 = ten_post$intercept[i] + ten_post$beta1 * ten_post$bp[i], 
           col = alpha(3, .1))
  segments(x1 = max(fishdat$prev), x0 = ten_post$bp[i], 
           y1 = ten_post$intercept[i] + 
             ten_post$beta2[i] * (max(fishdat$prev) - ten_post$bp[i]) + 
             ten_post$beta1[i] * max(fishdat$prev), 
           y0 = ten_post$intercept[i] + ten_post$slope_after * ten_post$bp[i], 
           col = alpha(2, .1))
}
```

